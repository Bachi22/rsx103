---
- name: Setup Docker-ELK stack with custom configs
  hosts: all
  become: yes
  gather_facts: yes

  vars_files:
    - elk_secret.yml

  vars:
    ip_addr: "{{ ansible_default_ipv4.address }}"

  tasks:
   # DEBUG
    - name: Nettoyer les anciens conteneurs et volumes
      shell: |
          docker rm -f $(docker ps -aq) || true
          docker volume rm $(docker volume ls -q) || true
      ignore_errors: true

    - name: Supprimer répertoire DOCKER
      file:
        path: "/opt/docker-elk"
        state: absent
      ignore_errors: true

   # REAL INSTALL
    - name: Afficher la valeur de ip_addr détectée automatiquement
      debug:
        msg: "L'adresse IP utilisée est : {{ ip_addr }}"

    - name: Cloner le dépôt docker-elk
      git:
        repo: https://github.com/deviantony/docker-elk.git
        dest: /opt/docker-elk
        version: main

    - name: Copier le kibana.yml custom
      template:
        src: kibana.yml.j2
        dest: /opt/docker-elk/kibana/config/kibana.yml
        mode: '0644'

    - name: Copier le .env custom
      template:
        src: env.j2
        dest: /opt/docker-elk/.env
        mode: '0644'

    - name: Copier le fleet-compose.yml custom
      copy:
        src: fleet-compose.yml
        dest: /opt/docker-elk/extensions/fleet/fleet-compose.yml
        mode: '0644'

    - name: Lancement "Du setup"
      command: docker-compose -f /opt/docker-elk/docker-compose.yml up setup
      args:
        chdir: /opt/docker-elk
      register: install_output

    - name: Afficher la sortie de l'installation
      debug:
        msg: "{{ install_output.stdout }}"

    - name: Docker-compose up -d -> Lancement kibana
      command: docker-compose -f /opt/docker-elk/docker-compose.yml up -d
      args:
        chdir: /opt/docker-elk
      register: launch_output

    - name: Afficher la sortie lancement
      debug:
        msg: "{{ launch_output.stdout }}"

    - name: Waiting for ELK basic stack launching
      ansible.builtin.pause:
        seconds: 30

    - name: Integrating fleet
      command: docker-compose -f /opt/docker-elk/docker-compose.yml -f /opt/docker-elk/extensions/fleet/fleet-compose.yml up -d
      args:
        chdir: /opt/docker-elk
      register: launch_output

    - name: Afficher la sortie lancement
      debug:
        msg: "{{ launch_output.stdout }}"

    - name: Is everything working?
      command: docker ps
      register: verif_output

    - name: Afficher la sortie docker ps
      debug:
        msg: "{{ verif_output.stdout }}"

    - name: Attendre que Kibana soit prêt
      uri:
        url: "http://localhost:5601/api/status"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10

    - name: Initialiser Fleet avec curl
      shell: |
        curl -u elastic:{{changeme}} -X POST "http://localhost:5601/api/fleet/setup" \
          -H 'Content-Type: application/json' \
          -H 'kbn-xsrf: true'
      register: fleet_setup_result
      until: fleet_setup_result.rc == 0
      retries: 10
      delay: 5

    - name: Créer une policy Fleet Server avec curl
      shell: |
        curl -s -X POST "http://localhost:5601/api/fleet/agent_policies" \
          -u elastic:{{changeme}}  \
          -H 'Content-Type: application/json' \
          -H 'kbn-xsrf: true' \
          -d '{
            "name": "Fleet Server Policy",
            "namespace": "default",
            "monitoring_enabled": ["logs", "metrics"]
          }' > /tmp/create_policy_result.json
      args:
        executable: /bin/bash

    - name: Récupérer toutes les policies Fleet existantes
      shell: |
        curl -s -u elastic:{{changeme}}  -X GET "http://localhost:5601/api/fleet/agent_policies" -H 'kbn-xsrf: true'
      register: all_policies_response
      args:
        executable: /bin/bash

    - name: Extraire l'ID de la Agent Policy APM Server
      set_fact:
        agent_policy_id: "{{ (all_policies_response.stdout | from_json)['items'] | selectattr('name', 'equalto', 'Agent Policy APM Server') | map(attribute='id') | list | first }}"

    - name: Créer un enrollment token pour Agent Policy APM Server
      shell: |
        curl -u elastic:{{changeme}}  -X POST "http://localhost:5601/api/fleet/enrollment_api_keys" \
          -H 'kbn-xsrf: true' \
          -H 'Content-Type: application/json' \
          -d '{
            "name": "apmserver-enrollment-token",
            "policy_id": "{{ agent_policy_id }}"
          }'
      register: enrollment_token_response
      until: enrollment_token_response.rc == 0
      retries: 5
      delay: 5

    - name: Extraire le token depuis la réponse curl
      set_fact:
        enrollment_token: "{{ enrollment_token_response.stdout | from_json | json_query('item.api_key') }}"

    - name: Afficher le token récupéré
      debug:
        msg: "Enrollment token récupéré: {{ enrollment_token }}"

    - name: Détection d'erreurs système critiques
      shell: >
        curl -k -u elastic:changeme
        -X POST "http://{{ ip_addr }}:5601/api/alerting/rule"
        -H "kbn-xsrf: true"
        -H "Content-Type: application/json"
        --data '{"params":{"index":["logs-*"],"timeField":"@timestamp","esQuery":"{\"query\":{\"bool\":{\"should\":[{\"query_string\":{\"query\":\"message:(\\\"kernel panic\\\" OR \\\"oom-killer\\\" OR \\\"segfault\\\" OR \\\"disk failure\\\")\"}}]}}}","size":100,"threshold":[0],"thresholdComparator":">","timeWindowSize":1,"timeWindowUnit":"m"},"consumer":"alerts","rule_type_id":".es-query","schedule":{"interval":"1m"},"name":"Erreur système critique","tags":["système","erreur","critique"],"actions":[]}'

    - name: Détection de redémarrages
      shell: >
        curl -k -u elastic:changeme
        -X POST "http://{{ ip_addr }}:5601/api/alerting/rule"
        -H "kbn-xsrf: true"
        -H "Content-Type: application/json"
        --data '{"params":{"index":["logs-*"],"timeField":"@timestamp","esQuery":"{\"query\":{\"match_phrase\":{\"message\":\"reboot\"}}}","size":100,"threshold":[2],"thresholdComparator":">","timeWindowSize":24,"timeWindowUnit":"h"},"consumer":"alerts","rule_type_id":".es-query","schedule":{"interval":"5m"},"name":"Détection de redémarrages","tags":["système","reboot"],"actions":[]}'

    - name: Monitoring de la charge CPU
      shell: >
        curl -k -u elastic:changeme
        -X POST "http://{{ ip_addr }}:5601/api/alerting/rule"
        -H "kbn-xsrf: true"
        -H "Content-Type: application/json"
        --data '{"params":{"index":["metrics-*"],"timeField":"@timestamp","esQuery":"{\"query\":{\"range\":{\"system.cpu.total.norm.pct\":{\"gte\":0.85}}}}","size":1,"threshold":[0],"thresholdComparator":">","timeWindowSize":5,"timeWindowUnit":"m"},"consumer":"alerts","rule_type_id":".es-query","schedule":{"interval":"1m"},"name":"Monitoring de la charge CPU","tags":["performance","cpu"],"actions":[]}'

    - name: Monitoring de l'utilisation de la mémoire RAM
      shell: >
        curl -k -u elastic:changeme
        -X POST "http://{{ ip_addr }}:5601/api/alerting/rule"
        -H "kbn-xsrf: true"
        -H "Content-Type: application/json"
        --data '{"params":{"index":["metrics-*"],"timeField":"@timestamp","esQuery":"{\"query\":{\"range\":{\"system.memory.used.pct\":{\"gte\":0.9}}}}","size":1,"threshold":[0],"thresholdComparator":">","timeWindowSize":5,"timeWindowUnit":"m"},"consumer":"alerts","rule_type_id":".es-query","schedule":{"interval":"1m"},"name":"Monitoring de la mémoire RAM","tags":["performance","mémoire"],"actions":[]}'

    - name: Arrêt d'une machine
      shell: |
        curl -k -u elastic:changeme \
          -X POST "http://{{ ip_addr }}:5601/api/alerting/rule" \
          -H "kbn-xsrf: true" \
          -H "Content-Type: application/json" \
          --data "{\"params\":{\"index\":[\"logs-*\"],\"timeField\":\"@timestamp\",\"esQuery\":\"{\\\"query\\\":{\\\"match_all\\\":{}}}\",\"size\":1,\"threshold\":[0],\"thresholdComparator\":\"<\",\"timeWindowSize\":1,\"timeWindowUnit\":\"m\"},\"consumer\":\"alerts\",\"rule_type_id\":\".es-query\",\"schedule\":{\"interval\":\"1m\"},\"name\":\"Arrêt d'une machine\",\"tags\":[\"système\",\"inactivité\"],\"actions\":[]}"

    - name: Monitoring de l'espace disque
      shell: |
        curl -k -u elastic:changeme \
          -X POST "http://{{ ip_addr }}:5601/api/alerting/rule" \
          -H "kbn-xsrf: true" \
          -H "Content-Type: application/json" \
          --data "{\"params\":{\"index\":[\"metrics-*\"],\"timeField\":\"@timestamp\",\"esQuery\":\"{\\\"query\\\":{\\\"range\\\":{\\\"system.filesystem.available.pct\\\":{\\\"lte\\\":0.1}}}}\",\"size\":1,\"threshold\":[0],\"thresholdComparator\":\"<\",\"timeWindowSize\":5,\"timeWindowUnit\":\"m\"},\"consumer\":\"alerts\",\"rule_type_id\":\".es-query\",\"schedule\":{\"interval\":\"1m\"},\"name\":\"Monitoring de l'espace disque\",\"tags\":[\"stockage\",\"disque\"],\"actions\":[]}"

    - name: Monitoring de l'utilisation du swap
      shell: |
        curl -k -u elastic:changeme \
          -X POST "http://{{ ip_addr }}:5601/api/alerting/rule" \
          -H "kbn-xsrf: true" \
          -H "Content-Type: application/json" \
          --data "{\"params\":{\"index\":[\"metrics-*\"],\"timeField\":\"@timestamp\",\"esQuery\":\"{\\\"query\\\":{\\\"range\\\":{\\\"system.memory.swap.used.pct\\\":{\\\"gte\\\":0.2}}}}\",\"size\":1,\"threshold\":[0],\"thresholdComparator\":\">\",\"timeWindowSize\":5,\"timeWindowUnit\":\"m\"},\"consumer\":\"alerts\",\"rule_type_id\":\".es-query\",\"schedule\":{\"interval\":\"1m\"},\"name\":\"Monitoring de l'utilisation du swap\",\"tags\":[\"mémoire\",\"swap\"],\"actions\":[]}"

- name: Installer l'agent Elastic sur machine distante
  hosts: all
  become: yes
  vars:
    enrollment_token: "{{ hostvars['localhost']['enrollment_token'] }}"
    elastic_version: "9.0.0"

  tasks:
    - name: Installer curl et unzip
      apt:
        name: [curl, unzip]
        state: present
        update_cache: yes

    - name: Télécharger l'agent Elastic
      get_url:
        url: "https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-{{ elastic_version }}-linux-x86_64.tar.gz"
        dest: /tmp/elastic-agent.tar.gz

    - name: Extraire l'archive
      unarchive:
        src: /tmp/elastic-agent.tar.gz
        dest: /opt/
        remote_src: yes

    - name: Enroll l'agent dans Fleet
      shell: |
        cd /opt/elastic-agent-{{ elastic_version }}-linux-x86_64
        ./elastic-agent install \
          --url=http://{{ ip_addr }}:8220 \
          --enrollment-token={{ enrollment_token }} \
          --insecure \
          --force
      args:
        creates: /opt/Elastic/Agent